export default function WorkLayout(props) {
  useEffect(() => {
    setTimeout(async () => {
      const secondary = document.querySelector(".canopy-work--secondary");
      const glossaryContainer = document.getElementById("glossary-section");
      const metadataDiv = secondary?.querySelector("div[data-canopy-metadata]"); // see note below

      if (!metadataDiv || !glossaryContainer) return;

      try {
        const { glossaryTerms } = await import("../../app/js/glossary-terms.js");
        const mod = await import("../../app/js/glossary-functions.js");

        // Only scan metadata text
        const textToScan = metadataDiv.textContent || "";

        const matches = mod.identifyGlossaryMatches(textToScan, glossaryTerms);

        // Highlight terms in metadata
        metadataDiv.innerHTML = mod.highlightGlossaryTermsString(textToScan, matches);

        // Populate glossary panel
        mod.renderGlossary(matches, glossaryContainer);

        // Attach tooltips
        mod.attachGlossaryTooltips(metadataDiv);

      } catch (e) {
        console.error("Glossary initialization failed:", e);
      }
    }, 200); // small delay to allow metadata to render
  }, []);

  return (
    <>
      <Container variant="wide" className="canopy-work--layout">
        <div className="canopy-work--primary">
          <Viewer iiifContent={props.manifest.id} />
        </div>

        <div className="canopy-work--secondary">
          <header>
            <Label manifest={props.manifest} as="h1" />
          </header>

          {/* Metadata only */}
          <Metadata manifest={props.manifest} />

          {/* Glossary panel */}
          <div id="glossary-section"></div>
        </div>
      </Container>

      <Container>
        <h2>Related Items</h2>
        <RelatedItems iiifContent={props.manifest.id} top={3} />
      </Container>
    </>
  );
}
